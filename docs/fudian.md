# 浮点功能部件开发文档

## 1. 浮点指令译码模块

**文件**：`FloatDecodeModule.scala`

### 1.1 输入/输出信号

| 信号名 | 方向 | 描述 |
|--------|------|------|
| `inst` | 输入 | 原始 32 位指令码 |
| `op` | 输出 | 复用 `BackendPackage` 中的 op 字段，用于在流水线内解析指令类型（非原始指令中的 opcode） |
| `func` | 输出 | 独热码，标志指令可被分派到的流水线，宽度等于流水线并行度 |
| `isFCMA` | 输出 | 1 位信号，标志指令是否为融合乘加指令，用于在 FPU 中启用特殊 datapath |
| `isFloat` | 输出 | 1 位信号，标志输入指令是否被识别为浮点指令 |

### 1.2 功能说明

- 支持译码 **F 扩展**和 **D 扩展**的全部指令
- 当 `func` 对应位为 1 时，表示该流水线中的功能单元可处理该指令
- 浮点译码模块逻辑与定点译码逻辑**完全并行**，两者独立生成各自的译码结果
- 使用 `isFloat` 信号控制 Mux，在两个译码结果中选择最终输出的 `op`、`func` 信号

---

## 2. 流水线模块

**目录**：`Pipeline/`

浮点流水线均以 `BackendPackage` 格式进行输入输出，具有通用参数：
- `expWidth`：指数位宽
- `precision`：尾数精度

### 2.1 流水线列表

| 流水线编号 | 模块名 | 功能描述 |
|------------|--------|----------|
| 0 | `PipelineFDiv` | 包含 FPU 和浮点除法部件 |
| 1-2 | `PipelineFPU` | 包含 ALU 和 FPU，处理算数、比较运算和格式转换指令 |
| 3-4 | `PipelineArith` | 包含定点 ALU 和定点乘除法部件，处理定点算术运算 |
| 5-6 | `PipelineAGU` | 包含 ALU，用于计算地址 |
| 7 | `PipelineBranch` | 包含 ALU 和分支单元 |

> **注**：架构图中流水线从右至左依次为 0~7 号流水线

### 2.2 输出规范

- 所有流水线的输出值均写入 `rfWdata` 字段
- 包含浮点计算的流水线会向 `fflags` 字段写入相应的浮点状态标志

### 2.3 PipelineFPU 参数说明

| 参数 | 值 | 功能 |
|------|-----|------|
| `convert` | 1 | 启用 `FPToInt`（浮点转整数） |
| `convert` | 0 | 启用 `IntToFP`（整数转浮点） |

---

## 3. 浮点除法控制信号接口

> 以下接口仅适用于 **0 号除法流水线**

### 3.1 控制信号

| 信号名 | 描述 |
|--------|------|
| `isSqrt` | 置 1 进入开方运算模式（仅支持平方根） |
| `kill` | 置 1 终止所有正在进行的运算 |

### 3.2 状态信号

| 信号名 | 描述 |
|--------|------|
| `out_valid` | 输出是否可用。**注意**：在 `out_valid` 置 1 后需**多打一拍**才能得到正确结果 |
| `in_ready` | 除法部件是否可接受新的输入，可用作 busy 信号。收到输入后置 0，运算结束后重置为 1，生成于第一级流水 |

> ⚠️ **关于 `out_valid` 的延迟问题**：推测是 Fudian 库实现时忘记了 FDIV 还有最后一级舍入，`out_valid` 在结束迭代后就被置 1 了。

---

## 4. 超越函数部件

*（待补充）*

---

## 附录

*（运行输出样例见文档末附录 - 待补充）*
